/**
 * Knoux Clipboard AI - Configuration Schema
 * JSON Schema and validation for application configuration
 * Generated by Knoux — Abu Retaj
 * Clipboard Intelligence • Desktop Precision • Premium Engineering
 */

import { z } from 'zod';
import { 
  ClipboardFormat, 
  AIModelType, 
  EncryptionAlgorithm, 
  Theme, 
  OperatingSystem,
  NotificationPosition,
  UpdateChannel,
  BackupFrequency,
  ExportFormat 
} from './enums';
import { 
  CONTENT_TYPES, 
  CLIPBOARD, 
  AI, 
  SECURITY, 
  UI, 
  DEFAULT_SETTINGS 
} from './constants';

// ==================== BASE SCHEMAS ====================

/**
 * UUID schema
 */
export const UUIDSchema = z.string().uuid();

/**
 * Timestamp schema (milliseconds since epoch)
 */
export const TimestampSchema = z.number().int().positive();

/**
 * File path schema
 */
export const FilePathSchema = z.string().min(1).max(4096);

/**
 * URL schema
 */
export const URLSchema = z.string().url();

/**
 * Email schema
 */
export const EmailSchema = z.string().email();

/**
 * Hex color schema
 */
export const HexColorSchema = z.string().regex(/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/);

/**
 * Base64 schema
 */
export const Base64Schema = z.string().regex(/^[A-Za-z0-9+/]*={0,2}$/);

// ==================== CLIPBOARD SCHEMAS ====================

/**
 * Clipboard content format schema
 */
export const ClipboardFormatSchema = z.nativeEnum(ClipboardFormat);

/**
 * Clipboard state schema
 */
export const ClipboardStateSchema = z.nativeEnum(ClipboardFormat);

/**
 * Clipboard monitoring settings schema
 */
export const ClipboardMonitoringSchema = z.object({
  enabled: z.boolean().default(DEFAULT_SETTINGS.clipboard.enableMonitoring),
  pollIntervalMs: z.number().int().min(100).max(10000).default(CLIPBOARD.POLL_INTERVAL_MS),
  detectionMode: z.enum(['polling', 'event_driven', 'hybrid', 'manual']).default('polling'),
  captureImages: z.boolean().default(DEFAULT_SETTINGS.clipboard.captureImages),
  captureHtml: z.boolean().default(DEFAULT_SETTINGS.clipboard.captureHtml),
  captureRtf: z.boolean().default(true),
  maxItemSizeKB: z.number().int().min(1).max(10240).default(1024),
  excludeApps: z.array(z.string()).max(50).default([]),
});

/**
 * Clipboard history settings schema
 */
export const ClipboardHistorySchema = z.object({
  maxItems: z.number().int().min(10).max(10000).default(DEFAULT_SETTINGS.clipboard.maxHistoryItems),
  autoClearSensitive: z.boolean().default(DEFAULT_SETTINGS.clipboard.autoClearSensitive),
  autoClearMinutes: z.number().int().min(1).max(1440).default(DEFAULT_SETTINGS.clipboard.autoClearMinutes),
  backupEnabled: z.boolean().default(true),
  backupIntervalHours: z.number().int().min(1).max(720).default(24),
  backupLocation: FilePathSchema.optional(),
  exportOnExit: z.boolean().default(false),
});

// ==================== AI SCHEMAS ====================

/**
 * AI model type schema
 */
export const AIModelTypeSchema = z.nativeEnum(AIModelType);

/**
 * AI engine configuration schema
 */
export const AIEngineSchema = z.object({
  enabled: z.boolean().default(DEFAULT_SETTINGS.ai.enabled),
  useLocalModel: z.boolean().default(DEFAULT_SETTINGS.ai.useLocalModel),
  useCloudApi: z.boolean().default(DEFAULT_SETTINGS.ai.useCloudApi),
  modelType: AIModelTypeSchema.default(AIModelType.LOCAL_LLAMA),
  modelPath: FilePathSchema.default(AI.LOCAL_MODEL_PATH),
  apiEndpoint: z.string().url().default(AI.CLOUD_API_ENDPOINT),
  apiKey: z.string().max(256).default(''),
  apiTimeoutMs: z.number().int().min(1000).max(30000).default(AI.ANALYSIS_TIMEOUT_MS),
  maxRetries: z.number().int().min(0).max(5).default(3),
  rateLimitPerMinute: z.number().int().min(1).max(1000).default(60),
});

/**
 * AI analysis settings schema
 */
export const AIAnalysisSchema = z.object({
  analyzeCode: z.boolean().default(DEFAULT_SETTINGS.ai.analyzeCode),
  analyzeText: z.boolean().default(DEFAULT_SETTINGS.ai.analyzeText),
  detectSensitive: z.boolean().default(DEFAULT_SETTINGS.ai.detectSensitive),
  cacheResults: z.boolean().default(DEFAULT_SETTINGS.ai.cacheResults),
  cacheDurationMinutes: z.number().int().min(1).max(10080).default(AI.CACHE_DURATION_MINUTES),
  maxContextLength: z.number().int().min(100).max(32000).default(AI.MAX_CONTEXT_LENGTH),
  confidenceThreshold: z.number().min(0.1).max(1.0).default(AI.CONFIDENCE_THRESHOLD),
  languageDetection: z.boolean().default(true),
  complexityAnalysis: z.boolean().default(true),
  suggestionGeneration: z.boolean().default(true),
  summaryGeneration: z.boolean().default(true),
});

/**
 * AI content classification schema
 */
export const AIClassificationSchema = z.object({
  enabledCategories: z.array(z.enum([
    'code', 'text', 'data', 'media', 'document', 'executable', 'other'
  ])).default(['code', 'text', 'data']),
  minConfidence: z.number().min(0.1).max(1.0).default(0.5),
  maxClassifications: z.number().int().min(1).max(10).default(3),
  fallbackToDefault: z.boolean().default(true),
  customPatterns: z.array(z.object({
    pattern: z.string().regex(/^.+$/),
    type: z.string().min(1).max(50),
    confidence: z.number().min(0.1).max(1.0),
  })).max(100).default([]),
});

// ==================== SECURITY SCHEMAS ====================

/**
 * Encryption algorithm schema
 */
export const EncryptionAlgorithmSchema = z.nativeEnum(EncryptionAlgorithm);

/**
 * Security settings schema
 */
export const SecuritySettingsSchema = z.object({
  encryptSensitive: z.boolean().default(DEFAULT_SETTINGS.security.encryptSensitive),
  requirePassword: z.boolean().default(DEFAULT_SETTINGS.security.requirePassword),
  password: z.string().min(0).max(256).default(''),
  autoLockMinutes: z.number().int().min(1).max(1440).default(DEFAULT_SETTINGS.security.autoLockMinutes),
  showSecurityAlerts: z.boolean().default(DEFAULT_SETTINGS.security.showSecurityAlerts),
  sandboxExternalContent: z.boolean().default(DEFAULT_SETTINGS.security.sandboxExternalContent),
  encryptionAlgorithm: EncryptionAlgorithmSchema.default(EncryptionAlgorithm.AES_GCM),
  keyDerivationIterations: z.number().int().min(1000).max(1000000).default(SECURITY.KEY_DERIVATION_ITERATIONS),
});

/**
 * Sensitive data detection schema
 */
export const SensitiveDetectionSchema = z.object({
  enabled: z.boolean().default(true),
  checkApiKeys: z.boolean().default(true),
  checkPasswords: z.boolean().default(true),
  checkTokens: z.boolean().default(true),
  checkCreditCards: z.boolean().default(true),
  checkPrivateKeys: z.boolean().default(true),
  checkPersonalInfo: z.boolean().default(false),
  autoMask: z.boolean().default(true),
  autoDelete: z.boolean().default(false),
  deleteAfterMinutes: z.number().int().min(1).max(10080).default(5),
  notifyUser: z.boolean().default(true),
  logIncidents: z.boolean().default(true),
});

/**
 * Permission settings schema
 */
export const PermissionSettingsSchema = z.object({
  clipboardRead: z.boolean().default(true),
  clipboardWrite: z.boolean().default(true),
  aiAnalysis: z.boolean().default(true),
  fileAccess: z.boolean().default(true),
  networkAccess: z.boolean().default(false),
  systemInfo: z.boolean().default(true),
  autostart: z.boolean().default(false),
  notifications: z.boolean().default(true),
});

// ==================== UI SCHEMAS ====================

/**
 * Theme schema
 */
export const ThemeSchema = z.nativeEnum(Theme);

/**
 * UI appearance schema
 */
export const UIApperanceSchema = z.object({
  theme: ThemeSchema.default(DEFAULT_SETTINGS.ui.theme),
  fontSize: z.number().int().min(8).max(32).default(DEFAULT_SETTINGS.ui.fontSize),
  fontFamily: z.string().min(1).max(256).default(DEFAULT_SETTINGS.ui.fontFamily),
  lineHeight: z.number().min(1.0).max(2.0).default(1.5),
  borderRadius: z.number().int().min(0).max(20).default(8),
  spacingUnit: z.number().int().min(2).max(16).default(8),
  animationsEnabled: z.boolean().default(DEFAULT_SETTINGS.ui.animationsEnabled),
  animationDuration: z.number().int().min(50).max(2000).default(300),
  reduceMotion: z.boolean().default(false),
  highContrast: z.boolean().default(false),
});

/**
 * Window settings schema
 */
export const WindowSettingsSchema = z.object({
  showTrayIcon: z.boolean().default(DEFAULT_SETTINGS.ui.showTrayIcon),
  minimizeToTray: z.boolean().default(DEFAULT_SETTINGS.ui.minimizeToTray),
  startMinimized: z.boolean().default(DEFAULT_SETTINGS.ui.startMinimized),
  alwaysOnTop: z.boolean().default(false),
  rememberPosition: z.boolean().default(true),
  defaultWidth: z.number().int().min(400).max(3840).default(UI.WINDOW.DEFAULT_WIDTH),
  defaultHeight: z.number().int().min(300).max(2160).default(UI.WINDOW.DEFAULT_HEIGHT),
  minWidth: z.number().int().min(200).max(1920).default(UI.WINDOW.MIN_WIDTH),
  minHeight: z.number().int().min(150).max(1080).default(UI.WINDOW.MIN_HEIGHT),
  maxWidth: z.number().int().min(400).max(7680).default(UI.WINDOW.MAX_WIDTH),
  maxHeight: z.number().int().min(300).max(4320).default(UI.WINDOW.MAX_HEIGHT),
});

/**
 * Hotkey schema
 */
export const HotkeySchema = z.object({
  enabled: z.boolean().default(DEFAULT_SETTINGS.ui.hotkeysEnabled),
  toggleWindow: z.string().min(1).max(50).default(UI.HOTKEYS.TOGGLE_WINDOW),
  quickSearch: z.string().min(1).max(50).default(UI.HOTKEYS.QUICK_SEARCH),
  clearClipboard: z.string().min(1).max(50).default(UI.HOTKEYS.CLEAR_CLIPBOARD),
  aiAnalyze: z.string().min(1).max(50).default(UI.HOTKEYS.AI_ANALYZE),
  historyPrev: z.string().min(1).max(50).default(UI.HOTKEYS.HISTORY_PREV),
  historyNext: z.string().min(1).max(50).default(UI.HOTKEYS.HISTORY_NEXT),
  customHotkeys: z.record(z.string(), z.string()).default({}),
});

// ==================== NOTIFICATION SCHEMAS ====================

/**
 * Notification position schema
 */
export const NotificationPositionSchema = z.nativeEnum(NotificationPosition);

/**
 * Notification settings schema
 */
export const NotificationSettingsSchema = z.object({
  enabled: z.boolean().default(DEFAULT_SETTINGS.notifications.enabled),
  sound: z.boolean().default(DEFAULT_SETTINGS.notifications.sound),
  duration: z.number().int().min(1000).max(10000).default(DEFAULT_SETTINGS.notifications.duration),
  position: NotificationPositionSchema.default(DEFAULT_SETTINGS.notifications.position as NotificationPosition),
  showOnClipboardUpdate: z.boolean().default(DEFAULT_SETTINGS.notifications.showOnClipboardUpdate),
  showOnAiAnalysis: z.boolean().default(DEFAULT_SETTINGS.notifications.showOnAiAnalysis),
  showOnSecurityAlert: z.boolean().default(DEFAULT_SETTINGS.notifications.showOnSecurityAlert),
  doNotDisturb: z.boolean().default(false),
  doNotDisturbStart: z.string().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/).default('22:00'),
  doNotDisturbEnd: z.string().regex(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/).default('07:00'),
  maxNotifications: z.number().int().min(1).max(50).default(10),
  autoDismiss: z.boolean().default(true),
});

// ==================== SYSTEM SCHEMAS ====================

/**
 * Operating system schema
 */
export const OperatingSystemSchema = z.nativeEnum(OperatingSystem);

/**
 * Update channel schema
 */
export const UpdateChannelSchema = z.nativeEnum(UpdateChannel);

/**
 * System settings schema
 */
export const SystemSettingsSchema = z.object({
  startOnLogin: z.boolean().default(false),
  checkForUpdates: z.boolean().default(true),
  updateChannel: UpdateChannelSchema.default(UpdateChannel.STABLE),
  autoInstallUpdates: z.boolean().default(false),
  analyticsEnabled: z.boolean().default(false),
  crashReportsEnabled: z.boolean().default(true),
  logsRetentionDays: z.number().int().min(1).max(365).default(30),
  performanceMode: z.enum(['power-saver', 'balanced', 'performance']).default('balanced'),
  memoryLimitMB: z.number().int().min(64).max(8192).default(512),
  cpuLimitPercent: z.number().int().min(10).max(100).default(50),
});

/**
 * Backup settings schema
 */
export const BackupSettingsSchema = z.object({
  enabled: z.boolean().default(true),
  frequency: z.nativeEnum(BackupFrequency).default(BackupFrequency.DAILY),
  maxBackups: z.number().int().min(1).max(100).default(30),
  location: FilePathSchema.optional(),
  includeSettings: z.boolean().default(true),
  includeHistory: z.boolean().default(true),
  includeAiCache: z.boolean().default(false),
  includeLogs: z.boolean().default(false),
  compressBackups: z.boolean().default(true),
  encryptionEnabled: z.boolean().default(false),
  encryptionKey: z.string().min(0).max(256).default(''),
});

// ==================== STORAGE SCHEMAS ====================

/**
 * Export format schema
 */
export const ExportFormatSchema = z.nativeEnum(ExportFormat);

/**
 * Storage settings schema
 */
export const StorageSettingsSchema = z.object({
  databasePath: FilePathSchema.default('userData/knoux-clipboard.db'),
  cachePath: FilePathSchema.default('userData/cache'),
  logsPath: FilePathSchema.default('userData/logs'),
  backupsPath: FilePathSchema.default('userData/backups'),
  maxDbSizeMB: z.number().int().min(10).max(10240).default(100),
  cleanupIntervalHours: z.number().int().min(1).max(720).default(24),
  exportFormat: ExportFormatSchema.default(ExportFormat.JSON),
  importConfirmation: z.boolean().default(true),
  autoExportOnClose: z.boolean().default(false),
});

// ==================== MAIN CONFIGURATION SCHEMA ====================

/**
 * Complete application configuration schema
 */
export const AppConfigSchema = z.object({
  version: z.string().regex(/^\d+\.\d+\.\d+$/).default('1.0.0'),
  environment: z.enum(['development', 'production', 'test']).default('development'),
  
  clipboard: z.object({
    monitoring: ClipboardMonitoringSchema,
    history: ClipboardHistorySchema,
  }).default({
    monitoring: DEFAULT_SETTINGS.clipboard,
    history: DEFAULT_SETTINGS.clipboard,
  }),
  
  ai: z.object({
    engine: AIEngineSchema,
    analysis: AIAnalysisSchema,
    classification: AIClassificationSchema,
  }).default({
    engine: DEFAULT_SETTINGS.ai,
    analysis: DEFAULT_SETTINGS.ai,
    classification: DEFAULT_SETTINGS.ai,
  }),
  
  security: z.object({
    settings: SecuritySettingsSchema,
    detection: SensitiveDetectionSchema,
    permissions: PermissionSettingsSchema,
  }).default({
    settings: DEFAULT_SETTINGS.security,
    detection: DEFAULT_SETTINGS.security,
    permissions: DEFAULT_SETTINGS.security,
  }),
  
  ui: z.object({
    appearance: UIApperanceSchema,
    window: WindowSettingsSchema,
    hotkeys: HotkeySchema,
  }).default({
    appearance: DEFAULT_SETTINGS.ui,
    window: DEFAULT_SETTINGS.ui,
    hotkeys: DEFAULT_SETTINGS.ui,
  }),
  
  notifications: NotificationSettingsSchema.default(DEFAULT_SETTINGS.notifications),
  
  system: z.object({
    settings: SystemSettingsSchema,
    backup: BackupSettingsSchema,
  }).default({
    settings: DEFAULT_SETTINGS.system,
    backup: DEFAULT_SETTINGS.system,
  }),
  
  storage: StorageSettingsSchema.default({
    databasePath: 'userData/knoux-clipboard.db',
    cachePath: 'userData/cache',
    logsPath: 'userData/logs',
    backupsPath: 'userData/backups',
    maxDbSizeMB: 100,
    cleanupIntervalHours: 24,
    exportFormat: ExportFormat.JSON,
    importConfirmation: true,
    autoExportOnClose: false,
  }),
  
  // Metadata
  metadata: z.object({
    createdAt: TimestampSchema.default(Date.now()),
    updatedAt: TimestampSchema.default(Date.now()),
    createdBy: z.string().default('system'),
    lastModifiedBy: z.string().default('system'),
    signature: z.string().optional(),
  }).default({
    createdAt: Date.now(),
    updatedAt: Date.now(),
    createdBy: 'system',
    lastModifiedBy: 'system',
  }),
});

// ==================== TYPE INFERENCES ====================

/**
 * Inferred TypeScript types from schemas
 */
export type AppConfig = z.infer<typeof AppConfigSchema>;
export type ClipboardMonitoringConfig = z.infer<typeof ClipboardMonitoringSchema>;
export type AIEngineConfig = z.infer<typeof AIEngineSchema>;
export type SecuritySettingsConfig = z.infer<typeof SecuritySettingsSchema>;
export type UIApperanceConfig = z.infer<typeof UIApperanceSchema>;
export type NotificationSettingsConfig = z.infer<typeof NotificationSettingsSchema>;
export type SystemSettingsConfig = z.infer<typeof SystemSettingsSchema>;
export type StorageSettingsConfig = z.infer<typeof StorageSettingsSchema>;

// ==================== VALIDATION FUNCTIONS ====================

/**
 * Validate application configuration
 */
export function validateAppConfig(config: unknown): AppConfig {
  return AppConfigSchema.parse(config);
}

/**
 * Validate and sanitize configuration with defaults
 */
export function sanitizeConfig(config: Partial<AppConfig>): AppConfig {
  return AppConfigSchema.parse({
    ...config,
    metadata: {
      ...config.metadata,
      updatedAt: Date.now(),
      lastModifiedBy: 'user',
    },
  });
}

/**
 * Merge partial configuration with defaults
 */
export function mergeWithDefaults(partial: Partial<AppConfig>): AppConfig {
  const defaults = AppConfigSchema.parse({});
  return AppConfigSchema.parse({ ...defaults, ...partial });
}

/**
 * Get configuration for specific module
 */
export function getModuleConfig<T extends keyof AppConfig>(
  config: AppConfig,
  module: T
): AppConfig[T] {
  return config[module];
}

/**
 * Update module configuration
 */
export function updateModuleConfig<T extends keyof AppConfig>(
  config: AppConfig,
  module: T,
  updates: Partial<AppConfig[T]>
): AppConfig {
  return AppConfigSchema.parse({
    ...config,
    [module]: { ...config[module], ...updates },
    metadata: {
      ...config.metadata,
      updatedAt: Date.now(),
      lastModifiedBy: 'user',
    },
  });
}

/**
 * Export configuration to JSON
 */
export function exportConfig(config: AppConfig): string {
  return JSON.stringify(config, null, 2);
}

/**
 * Import configuration from JSON
 */
export function importConfig(json: string): AppConfig {
  try {
    const parsed = JSON.parse(json);
    return validateAppConfig(parsed);
  } catch (error) {
    throw new Error(`Failed to import configuration: ${error instanceof Error ? error.message : 'Unknown error'}`);
  }
}

/**
 * Get default configuration
 */
export function getDefaultConfig(): AppConfig {
  return AppConfigSchema.parse({});
}

/**
 * Reset configuration to defaults
 */
export function resetConfig(): AppConfig {
  return getDefaultConfig();
}

/**
 * Validate configuration against schema
 */
export function isValidConfig(config: unknown): config is AppConfig {
  try {
    AppConfigSchema.parse(config);
    return true;
  } catch {
    return false;
  }
}

// ==================== CONFIGURATION CONSTANTS ====================

/**
 * Default configuration file name
 */
export const CONFIG_FILE_NAME = 'knoux-config.json';

/**
 * Configuration file encoding
 */
export const CONFIG_FILE_ENCODING = 'utf8';

/**
 * Configuration backup file pattern
 */
export const CONFIG_BACKUP_PATTERN = 'knoux-config-backup-*.json';

/**
 * Maximum configuration file size (10MB)
 */
export const MAX_CONFIG_FILE_SIZE = 10 * 1024 * 1024;

/**
 * Configuration schema version
 */
export const CONFIG_SCHEMA_VERSION = '1.0.0';
